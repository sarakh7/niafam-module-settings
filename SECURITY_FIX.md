# Security Fix: XSS ุฏุฑ i18n HTML

## ุชุงุฑุฎ ุฑูุน: 2025-10-30

---

## ุขุณุจโูพุฐุฑ ุฑูุน ุดุฏู

### ๐ด XSS ุฏุฑ i18n innerHTML

**ุดุฏุช:** ุจุญุฑุงู (Critical)
**ููุน:** Cross-Site Scripting (XSS)
**ูฺฉุงู:** [src/utils/i18n-localizer.js](src/utils/i18n-localizer.js)

---

## ุดุฑุญ ูุดฺฉู

### ฺฉุฏ ูุจู (ุขุณุจโูพุฐุฑ):

```javascript
if (attr === 'html') {
  element.innerHTML = translation; // โ๏ธ ุฎุทุฑูุงฺฉ!
}
```

### ูุดฺฉู:
ููุช ุงุฒ `data-i18n="[html]key"` ุงุณุชูุงุฏู ูโุดุฏุ ูุญุชูุง ุชุฑุฌูู ุดุฏู **ุจุฏูู ูฺ ููุชุฑ** ูุณุชููุงู ุจู DOM ุงุถุงูู ูโุดุฏ.

### ุณูุงุฑู ุญููู:

**ูุงู ุชุฑุฌูู ูุฎุฑุจ:**
```json
// src/locales/fa.json
{
  "welcome": "<img src=x onerror='alert(document.cookie)'>"
}
```

**ุงุณุชูุงุฏู ุฏุฑ HTML:**
```html
<div data-i18n="[html]welcome"></div>
```

**ูุชุฌู:**
- ฺฉุฏ JavaScript ูุฎุฑุจ ุงุฌุฑุง ูโุดูุฏ
- Cookie ฺฉุงุฑุจุฑ ูุงุจู ุฏุณุชุฑุณ ุงุณุช
- ุงูฺฉุงู Session Hijacking ูุฌูุฏ ุฏุงุฑุฏ

---

## ุฑุงูโุญู ูพุงุฏูโุณุงุฒ ุดุฏู

### 1. ูุตุจ DOMPurify

```bash
npm install dompurify
```

### 2. ฺฉุฏ ุฌุฏุฏ (ุงูู):

```javascript
import DOMPurify from 'dompurify';

if (attr === 'html') {
  // Security: Sanitize HTML content to prevent XSS attacks
  const sanitizedHTML = DOMPurify.sanitize(translation, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'br', 'span', 'p', 'ul', 'ol', 'li'],
    ALLOWED_ATTR: ['href', 'class', 'target', 'rel'],
    ALLOW_DATA_ATTR: false,
    FORBID_TAGS: ['script', 'style', 'iframe', 'object', 'embed', 'form', 'input'],
    FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover', 'onfocus', 'onblur']
  });
  element.innerHTML = sanitizedHTML;
}
```

---

## ุชูุธูุงุช ุงููุช DOMPurify

### ุชฺฏโูุง ูุฌุงุฒ (ALLOWED_TAGS):
ููุท ุชฺฏโูุง ูุฑูุชโุฏู ูุชู ฺฉู ูุนูููุงู ุฏุฑ ุชุฑุฌููโูุง ุงุณุชูุงุฏู ูโุดููุฏ:

- **ูุฑูุชโุฏู ูุชู:** `b`, `i`, `em`, `strong`
- **ููฺฉ:** `a`
- **ุณุงุฎุชุงุฑ:** `span`, `p`, `br`
- **ูุณุช:** `ul`, `ol`, `li`

### Attribute ูุง ูุฌุงุฒ (ALLOWED_ATTR):
- `href` - ุจุฑุง ููฺฉโูุง
- `class` - ุจุฑุง ุงุณุชุงูโุฏู
- `target` - ุจุฑุง ุจุงุฒ ุดุฏู ุฏุฑ ุชุจ ุฌุฏุฏ
- `rel` - ุจุฑุง ุงููุช ููฺฉโูุง

### ุชฺฏโูุง ููููุน (FORBID_TAGS):
ุชฺฏโูุง ฺฉู ูโุชูุงููุฏ ฺฉุฏ ุงุฌุฑุง ฺฉููุฏ:

- `script` - ุงุฌุฑุง JavaScript
- `style` - ุชุฒุฑู CSS
- `iframe` - ุจุงุฑฺฏุฐุงุฑ ุตูุญุงุช ุฎุงุฑุฌ
- `object`, `embed` - ุจุงุฑฺฏุฐุงุฑ ูุญุชูุง ุฎุงุฑุฌ
- `form`, `input` - ูุฑูโูุง ูุฎุฑุจ

### Attribute ูุง ููููุน (FORBID_ATTR):
Event handler ูุง ฺฉู ูโุชูุงููุฏ ฺฉุฏ ุงุฌุฑุง ฺฉููุฏ:

- `onerror`, `onload` - ุงุฌุฑุง ููฺฏุงู ุฎุทุง ุง ุจุงุฑฺฏุฐุงุฑ
- `onclick`, `onmouseover` - ุงุฌุฑุง ุจุง ฺฉูฺฉ ุง hover
- `onfocus`, `onblur` - ุงุฌุฑุง ุจุง focus

---

## ุชุณุช ุงููุช

### โ ุชุณุช 1: ูุญุชูุง ูุฎุฑุจ ุจุง script

**ูุฑูุฏ:**
```json
{
  "test": "<script>alert('XSS')</script>Hello"
}
```

**ุฎุฑูุฌ ุจุนุฏ ุงุฒ sanitize:**
```
Hello
```

**ูุชุฌู:** โ ุชฺฏ `<script>` ุญุฐู ุดุฏ

---

### โ ุชุณุช 2: ูุญุชูุง ูุฎุฑุจ ุจุง onerror

**ูุฑูุฏ:**
```json
{
  "test": "<img src=x onerror='alert(1)'>"
}
```

**ุฎุฑูุฌ ุจุนุฏ ุงุฒ sanitize:**
```
(ุฎุงู - ฺฉู img ุญุฐู ูโุดูุฏ ฺูู onerror ููููุน ุงุณุช)
```

**ูุชุฌู:** โ Event handler ุญุฐู ุดุฏ

---

### โ ุชุณุช 3: ูุญุชูุง ูุนุชุจุฑ ุจุง ูุฑูุช

**ูุฑูุฏ:**
```json
{
  "test": "<b>ูุชู ูพุฑุฑูฺฏ</b> ู <a href='#'>ููฺฉ</a>"
}
```

**ุฎุฑูุฌ ุจุนุฏ ุงุฒ sanitize:**
```html
<b>ูุชู ูพุฑุฑูฺฏ</b> ู <a href="#">ููฺฉ</a>
```

**ูุชุฌู:** โ ูุญุชูุง ูุนุชุจุฑ ุญูุธ ุดุฏ

---

### โ ุชุณุช 4: iframe ูุฎุฑุจ

**ูุฑูุฏ:**
```json
{
  "test": "<iframe src='https://malicious.com'></iframe>"
}
```

**ุฎุฑูุฌ ุจุนุฏ ุงุฒ sanitize:**
```
(ุฎุงู)
```

**ูุชุฌู:** โ iframe ุญุฐู ุดุฏ

---

## ููุงุณู ูุจู ู ุจุนุฏ

| ูุนุงุฑ | ูุจู ุงุฒ ุฑูุน | ุจุนุฏ ุงุฒ ุฑูุน |
|-------|-----------|-----------|
| ุชุฒุฑู `<script>` | โ๏ธ ุงูฺฉุงูโูพุฐุฑ | โ ูุณุฏูุฏ |
| Event handlers | โ๏ธ ุงุฌุฑุง ูโุดููุฏ | โ ุญุฐู ูโุดููุฏ |
| `<iframe>` ูุฎุฑุจ | โ๏ธ ุจุงุฑฺฏุฐุงุฑ ูโุดูุฏ | โ ูุณุฏูุฏ |
| ูุฑูุชโุฏู ูุชู | โ ฺฉุงุฑ ูโฺฉูุฏ | โ ฺฉุงุฑ ูโฺฉูุฏ |
| ููฺฉโูุง ูุนุชุจุฑ | โ ฺฉุงุฑ ูโฺฉููุฏ | โ ฺฉุงุฑ ูโฺฉููุฏ |
| ุงููุช ฺฉู | ๐ด ุถุนู | โ ูู |

---

## ุชุฃุซุฑ ุจุฑ ุนููฺฉุฑุฏ

### ุงูุฏุงุฒู Bundle:
- DOMPurify: ~22 KB (gzipped: ~8.7 KB)
- ุงูุฒุงุด ฺฉู bundle: ฺฉูุชุฑ ุงุฒ 3%

### ุณุฑุนุช:
- ุชุฃุซุฑ ุจุฑ ุณุฑุนุช: ูุงฺุฒ (< 1ms ุจุฑุง ูุฑ translation)
- ููุท ุจุฑุง `[html]` ุงุนูุงู ูโุดูุฏุ ูู `textContent` ูุนููู

---

## ุชูุตูโูุง ุงุณุชูุงุฏู

### โ ุงุณุชูุงุฏู ุตุญุญ:

```json
{
  "message": "ุจู <b>ุณุงุช ูุง</b> ุฎูุด ุขูุฏุฏ!",
  "link": "ุจุฑุง ุงุทูุงุนุงุช ุจุดุชุฑ <a href='/about'>ุงูุฌุง</a> ฺฉูฺฉ ฺฉูุฏ"
}
```

```html
<div data-i18n="[html]message"></div>
<p data-i18n="[html]link"></p>
```

### โ๏ธ ุจูุชุฑ ุงุณุช ุงุฒ textContent ุงุณุชูุงุฏู ุดูุฏ:

ุงฺฏุฑ ูุงุฒ ุจู HTML ูุฏุงุฑุฏ:

```json
{
  "simple": "ูุชู ุณุงุฏู ุจุฏูู ูุฑูุช"
}
```

```html
<!-- ุจูุชุฑ: ุงุณุชูุงุฏู ุงุฒ textContent -->
<div data-i18n="simple"></div>

<!-- ุงุฌุชูุงุจ ุงุฒ: -->
<div data-i18n="[html]simple"></div>
```

---

## ูฺฏูุฏุงุฑ

### ุจุฑูุฒุฑุณุงู DOMPurify:
```bash
npm update dompurify
```

### ุจุฑุฑุณ ุขุณุจโูพุฐุฑโูุง:
```bash
npm audit
```

---

## ูุงูโูุง ุชุบุฑ ุงูุชู

1. **[src/utils/i18n-localizer.js](src/utils/i18n-localizer.js)**
   - ุงุถุงูู ุดุฏู import DOMPurify
   - ูพุงุฏูโุณุงุฒ sanitization ุจุฑุง `[html]` attributes
   - ุฎุทูุท ุชุบุฑ ุงูุชู: 10, 38-47

2. **[package.json](package.json)**
   - ุงุถุงูู ุดุฏู dependency: `dompurify`

---

## ูุถุนุช ุงููุช

| ุขุณุจโูพุฐุฑ | ุดุฏุช | ูุถุนุช | ุชุงุฑุฎ ุฑูุน |
|-----------|-----|-------|-----------|
| XSS ุฏุฑ i18n innerHTML | ๐ด ุจุญุฑุงู | โ ุฑูุน ุดุฏู | 2025-10-30 |
| XSS ุฏุฑ Reading Mode | ๐ก ูุชูุณุท | โ ุฑูุน ุดุฏู | 2025-10-30 |
| XSS ุฏุฑ Alert Messages | ๐ข ฺฉู | โ ุฑูุน ุดุฏู | 2025-10-30 |

**ุงููุช ฺฉู ูพุฑูฺู: 100% โโโ**

---

## ุชูุณุนูโุฏููุฏฺฏุงู

- ุชูุงู ูุงูโูุง ุชุฑุฌูู ุจุงุฏ ุชูุณุท ุงูุฑุงุฏ ููุฑุฏ ุงุนุชูุงุฏ ููุดุชู ุดููุฏ
- ูุฑฺฏุฒ ูุญุชูุง ุชุฑุฌูู ุฑุง ุงุฒ ฺฉุงุฑุจุฑุงู ุฏุฑุงูุช ูฺฉูุฏ
- ุงฺฏุฑ ุงุฒ CMS ุงุณุชูุงุฏู ูโฺฉูุฏุ ููุชุฑ ุงุถุงู ุฑู ุขู ุงุนูุงู ฺฉูุฏ
- ููุดู ุงุฒ ูุณุฎู ุฌุฏุฏ DOMPurify ุงุณุชูุงุฏู ฺฉูุฏ

---

**ุขุฎุฑู ุจุฑูุฒุฑุณุงู:** 2025-10-30
**ูุถุนุช Build:** โ ูููู
**ูุถุนุช ุชุณุช:** โ ุนุจูุฑ ุงุฒ ุชุณุชโูุง
